# Plan: Adversarial Redesign Coverage Closeout (Gate = 0 Issues)

**Generated**: 2026-02-09
**Estimated Complexity**: High

## Overview
Bring `tools/gate_adversarial_redesign_coverage.py` to **PASS** (`issues=0`) while also fixing the observed WSL OOM instability (dozens of lingering `host_runner` python processes) and the fixture accuracy regressions (only 2/4 correct in the screenshot sample).

This plan is written to preserve the non-negotiables from the operating manual:
- Localhost-only; fail closed.
- No deletion endpoints; archive/migrate only.
- Raw-first local store; sanitize only on explicit export/egress.
- Foreground gating: when user is ACTIVE, only capture + kernel runs; heavy processing is idle-only.
- Idle budgets enforced (CPU<=50%, RAM<=50%).
- Answers require citations by default.

This plan is **CLI + API first**. UI items are implemented as minimal routes/JSON and deterministic tests; the actual UI rebuild happens later.

## Inputs / Source Of Truth
- Spec: `docs/autocapture_prime_adversarial_redesign.md`
- Gate: `PYTHONPATH=. .venv/bin/python tools/gate_adversarial_redesign_coverage.py --format=short`
- Traceability: `tools/traceability/adversarial_redesign_traceability.json` (generated by the gate)

## Current Gate Snapshot (2026-02-09)
Gate currently fails with **60** issues:
- `EXEC-*`: EXEC-04..EXEC-07 (partial)
- `EXT-*`: EXT-01..EXT-12 (partial)
- `META-*`: META-04 (partial), META-07 (partial), META-08..META-09 (missing)
- `OPS-*`: OPS-05..OPS-08 (partial)
- `PERF-*`: PERF-01 (partial), PERF-02..PERF-05 (missing), PERF-06 (partial), PERF-08 (partial)
- `QA-*`: QA-01..QA-04 (missing), QA-06 (missing), QA-08 (missing)
- `RD-*`: RD-01..RD-04 (missing), RD-06 has missing validators
- `SEC-*`: SEC-02..SEC-03 (partial), SEC-05..SEC-09 (missing), SEC-10 (partial)
- `UX-*`: UX-01..UX-06 (partial), UX-07 (missing), UX-08..UX-10 (partial)

## Global Acceptance Criteria (Definition Of Done)
- Gate passes: `tools/gate_adversarial_redesign_coverage.py` returns success with `issues=0`.
- All validators referenced by traceability are deterministic, run in single-process mode, and pass.
- Fixture validation passes for:
  - Screenshot pipeline: `docs/test sample/Screenshot 2026-02-02 113519.png`
  - (Optional) MP4 pipeline remains supported but is disabled by default.
- Plugin host stability: after fixture validation, there are **no** lingering `python -m autocapture_nx.plugin_system.host_runner ... create_plugin ...` processes.
- Capture is ultralight: ACTIVE capture at 0.5s cadence (2 fps), IDLE at 60s cadence; dedupe enabled; no user-visible interference.
- No new `TODO`/`FIXME`/`not implemented` placeholders in code. If scope changes, document it in `docs/reports/` only.

## Prerequisites
- `.venv` present and working.
- `ffmpeg` installed (only needed when validating MP4 fixtures).

## Sprint 0: Make Fixture + Safe Mode Deterministic (Stops “no_evidence”)
**Goal**: Ensure fixture runs always produce evidence + derived text + citations without enabling heavy extractors in foreground.
**Demo/Validation**:
- Run the fixture pipeline once and confirm:
  - evidence records are discoverable by metadata store,
  - OCR derived artifacts exist,
  - queries return `answer.state=ok` with resolvable citations.

### Task 0.1: Safe-Mode Capability Set Must Support Querying (Still Fail Closed)
- **Location**: `config/default.json`, `autocapture_nx/kernel/loader.py`, `docs/safe_mode.md`
- **Description**: Expand `kernel.safe_mode_required_capabilities` to include the minimum set required to:
  - load metadata + decrypt (keyring),
  - run retrieval/answer/citation in query mode,
  - run lightweight OCR in fixture mode (but keep `kernel.safe_mode_overrides.processing.*` blocking heavy background processing).
- **Complexity**: 7
- **Dependencies**: None
- **Acceptance Criteria**:
  - Fixture query no longer returns `no_evidence` due to missing capability providers.
- **Validation**:
  - Add `tests/test_safe_mode_query_capabilities.py`.

### Task 0.2: Evidence Detection Must Not Depend On `metadata.keys()` Being Available
- **Location**: `tools/run_fixture_pipeline.py`, `autocapture_nx/ux/fixture.py`, `plugins/builtin/storage_encrypted/plugin.py`
- **Description**: Fix `_collect_evidence()` / evidence discovery to work across:
  - wrapped providers (fanout/fallback),
  - subprocess allowlists where `.keys()` is blocked,
  - encrypted stores where `.get()` can fail without keyring.
- **Complexity**: 6
- **Dependencies**: Task 0.1
- **Acceptance Criteria**:
  - `_wait_for_evidence()` returns at least one evidence ID for the PNG fixture within 10s.
- **Validation**:
  - Add `tests/test_fixture_evidence_discovery.py`.

### Task 0.3: Fixture Accuracy For “Time / Quorum Collaborator / Inbox Count”
- **Location**: `autocapture_nx/processing/*`, `plugins/builtin/ocr_*`, `plugins/builtin/window_metadata_windows/*`
- **Description**: Ensure these questions are answerable from extracted metadata only (no reprocessing during query):
  - “what time is it on the vdi”
  - “who is working with me on the quorum task”
  - “how many inboxes I have open”
- **Complexity**: 8
- **Dependencies**: Task 0.2
- **Acceptance Criteria**:
  - Screenshot fixture produces correct answers for all 4 questions.
- **Validation**:
  - Extend `docs/test sample/fixture_manifest.json` checks and add a deterministic pytest wrapper `tests/test_fixture_queries_png.py`.

## Sprint 1: Stop Plugin Host Process Explosion (WSL OOM Fix)
**Goal**: Ensure subprocess plugin hosts are capped, reused only when safe, and always cleaned up.
**Demo/Validation**:
- Run the PNG fixture pipeline and confirm only a small bounded number of host processes exist transiently, and none remain after completion.

### Task 1.1: Enforce Host Spawn Caps (Concurrency + Total Processes)
- **Location**: `autocapture_nx/plugin_system/host.py`, `autocapture_nx/plugin_system/runtime.py`, `autocapture_nx/plugin_system/registry.py`
- **Description**: Ensure plugin creation and probing respects:
  - `plugins.hosting.max_hosts` total,
  - `plugins.hosting.spawn_concurrency` for concurrent spawns,
  - deterministic teardown of hosts after a create/probe flow.
- **Complexity**: 9
- **Dependencies**: Sprint 0
- **Acceptance Criteria**:
  - No lingering host_runner processes after fixture run.
- **Validation**:
  - Add `tests/test_plugin_host_teardown.py`.

### Task 1.2: Per-Capability Probe Must Never Fan Out By Default
- **Location**: `autocapture_nx/ux/fixture.py`, `tools/fixture_config_template.json`, `contracts/config_schema.json`
- **Description**: Default `tools.fixture.probe_all_providers=false` and ensure it is honored.
- **Complexity**: 4
- **Dependencies**: None
- **Validation**:
  - Add `tests/test_fixture_probe_does_not_fan_out.py`.

### Task 1.3: Plugin Execution Timing Metrics (For 4 Pillars)
- **Location**: `plugins/builtin/observability_basic/*`, `autocapture_nx/plugin_system/host.py`, `autocapture_nx/plugin_system/host_runner.py`
- **Description**: Emit per-plugin timing and per-capability call timing:
  - process spawn time,
  - `create_plugin` time,
  - per-RPC call p50/p95,
  - failures/timeouts.
- **Complexity**: 7
- **Dependencies**: Task 1.1
- **Validation**:
  - Add `tests/test_plugin_metrics_emitted.py`.

## Sprint 2: Capture Is Ultralight And Never Drops (Within Disk Reality)
**Goal**: ACTIVE screenshot capture every 0.5s with dedupe; IDLE every 60s; never drop due to transient processing backpressure.
**Demo/Validation**:
- Run a short local soak (60s) and confirm exact expected frame counts are persisted (after dedupe).

### Task 2.1: Separate Capture Spool From Processing (Durable Queue)
- **Location**: `autocapture_nx/capture/pipeline.py`, `plugins/builtin/backpressure_basic/*`, `plugins/builtin/storage_*`
- **Description**: Write captured screenshots to a durable “spool” queue first (append-only), then ingest into canonical evidence store asynchronously (idle-only).
- **Complexity**: 9
- **Dependencies**: Sprint 1
- **Acceptance Criteria**:
  - Capture can continue at 2fps even if ingestion/processing is paused.
- **Validation**:
  - Add `tests/test_capture_spool_never_drops_under_pause.py`.

### Task 2.2: Secondary Overflow Spool Path (C: fallback when D: pressured)
- **Location**: `config/default.json`, `contracts/config_schema.json`, `autocapture_nx/kernel/paths.py`, `autocapture_nx/capture/pipeline.py`
- **Description**: Add config for `storage.spool_overflow_dir` (optional). If the primary spool is under disk pressure, write to overflow.
- **Complexity**: 6
- **Dependencies**: Task 2.1
- **Validation**:
  - Add `tests/test_capture_spool_overflow_path_used.py`.

## Sprint 3: Close Remaining Gate Items (EXT/META/OPS/PERF/QA/SEC/UX/RD)
**Goal**: Implement remaining missing/partial items with deterministic validators.
**Demo/Validation**:
- Gate passes and fixture tests pass.

### Task 3.1: Close EXEC-04..EXEC-07
- **Location**: `autocapture_nx/kernel/replay.py`, `autocapture_nx/kernel/query.py`, `autocapture_nx/processing/idle.py`
- **Description**: Implement replay + explicit “schedule extraction” jobs; ensure no on-query media reprocessing.
- **Complexity**: 8
- **Validation**:
  - Add/enable tests referenced in traceability.

### Task 3.2: Close EXT-01..EXT-12
- **Location**: `autocapture_nx/plugin_system/*`, `autocapture_nx/cli.py`, `autocapture/web/routes/plugins.py`
- **Description**: Lifecycle state machine + install/update/rollback + compatibility contracts + lock signing.
- **Complexity**: 10
- **Validation**:
  - Implement the referenced tests in traceability.

### Task 3.3: Close PERF-02..PERF-05 and PERF-08
- **Location**: `autocapture/indexing/*`, `autocapture/runtime/wsl2_queue.py`, `autocapture_nx/runtime/governor.py`
- **Description**: Incremental indexing + extractor caching keys + WSL2 roundtrip (kept disabled by default) + deterministic resource panel plumbing.
- **Complexity**: 10
- **Validation**:
  - Implement the referenced perf tests and keep them single-process.

### Task 3.4: Close QA-01..QA-04, QA-06, QA-08
- **Location**: `tests/*`, `tools/gate_security.py`
- **Description**: Golden query fixtures, chaos recovery, fuzz validation, security regression, proof bundle verify.
- **Complexity**: 10
- **Validation**:
  - Ensure tests are deterministic and bounded (no network, no large models).

### Task 3.5: Close SEC-02..SEC-10
- **Location**: `autocapture_nx/plugin_system/runtime.py`, `autocapture/web/api.py`, `autocapture_nx/kernel/proof_bundle.py`
- **Description**: Early network guard, loopback enforcement, export redaction, key rotation, proof bundle signing, secrets hygiene.
- **Complexity**: 10
- **Validation**:
  - Implement referenced tests and add `tools/gate_secrets.py`.

### Task 3.6: Close UX-01..UX-10 (Minimal Routes + Deterministic UI Smoke)
- **Location**: `autocapture/web/routes/*`, `autocapture/web/ui/*`
- **Description**: Minimal JSON endpoints and smoke tests; keep UI work minimal.
- **Complexity**: 8
- **Validation**:
  - Add `tests/test_ui_smoke.py` (headless, deterministic).

## Testing Strategy
- Prefer running targeted tests by filename; keep `pytest` single-worker.
- Add a dedicated runner script that executes:
  - adversarial gate,
  - PNG fixture pipeline validation,
  - (optional) MP4 fixture validation,
  - plugin-host teardown check,
  - resource metrics capture.

## Potential Risks & Gotchas
- Safe mode must fail closed but still allow query surfaces; capability selection must not accidentally enable egress or heavy extractors.
- Encrypted storage requires keyring availability for metadata reads; fixture runs must ensure keyring is loaded.
- “Never drop” is physically limited by disk availability. Overflow spool mitigates but cannot eliminate a fully exhausted system.
- Windows ACTIVE/IDLE signals can be noisy; ensure capture cadence selection is deterministic and debounced.

## Rollback Plan
- All changes should be behind config flags and defaults that preserve fail-closed behavior.
- If capture spool changes regress, revert to current direct-to-evidence write path but keep host caps and fixture fixes.
- **Dependencies**: Sprint 2
- **Validation**:
  - Add `tests/test_run_config_snapshot.py`.

### Task 3.2: Plugin Provenance In Run Manifest
- **Location**: `autocapture_nx/plugin_system/registry.py`, `autocapture_nx/kernel/loader.py`
- **Description**: Record plugin_id/version/manifest hash/artifact hash/permissions at boot.
- **Complexity**: 6
- **Dependencies**: Sprint 1
- **Validation**:
  - Add `tests/test_plugin_provenance_in_manifest.py`.

### Task 3.3: Policy Snapshot Persistence By Hash (Ledger + Proof Bundle)
- **Location**: `autocapture_nx/kernel/policy_gate.py`, `plugins/builtin/ledger_basic/plugin.py`, `autocapture_nx/kernel/proof_bundle.py`
- **Description**: Persist full policy snapshot objects referenced by hash.
- **Complexity**: 8
- **Dependencies**: Sprint 2
- **Validation**:
  - Add `tests/test_policy_snapshot_exported.py`.

### Task 3.4: Health Checks / Doctor Matrix (Capture/OCR/VLM/Index/Retrieval/Answer)
- **Location**: `autocapture_nx/kernel/doctor.py`, `autocapture/web/routes/health.py`
- **Description**: Provide stable summary fields + full component matrix.
- **Complexity**: 7
- **Dependencies**: Sprint 1
- **Validation**:
  - Add `tests/test_component_health_matrix.py`, `tests/test_health_has_stable_fields.py`.

### Task 3.5: Structured JSONL Logging With Correlation IDs
- **Location**: `autocapture_nx/kernel/logging.py`, `autocapture_nx/plugin_system/host_runner.py`
- **Description**: Emit JSONL with `run_id`, `job_id`, `plugin_id`; rotate logs deterministically.
- **Complexity**: 8
- **Dependencies**: Sprint 1
- **Validation**:
  - Add `tests/test_logs_have_correlation_ids.py`.

### Task 3.6: Derived Artifact Manifests + Lineage (Content-Addressed)
- **Location**: `autocapture_nx/kernel/derived_records.py`, `autocapture_nx/kernel/metadata_store.py`, `autocapture_nx/kernel/proof_bundle.py`
- **Description**: Close META-07 by persisting a content-addressed artifact manifest for derived artifacts (OCR, VLM, embeddings, indexes) and record lineage pointers without reprocessing on query.
- **Complexity**: 9
- **Dependencies**: Tasks 3.1-3.3
- **Validation**:
  - Add `tests/test_artifact_manifest_lineage.py`.

### Task 3.7: Schema Version Enforcement at Write Boundaries
- **Location**: `contracts/*.schema.json`, `plugins/builtin/*`, `autocapture_nx/kernel/evidence.py`
- **Description**: Close META-04 by requiring `schema_version` fields and validating at write boundaries (refuse unknown versions).
- **Complexity**: 8
- **Dependencies**: Sprint 2
- **Validation**:
  - Add `tests/test_schema_version_enforced.py`.

### Task 3.8: Evaluation Records + Query Surfacing
- **Location**: `contracts/evaluation.schema.json` (new), `autocapture_nx/kernel/query.py`, `autocapture/web/routes/query.py`
- **Description**: Close META-08 by recording minimal evaluation results (quality/coverage/freshness) and surfacing them in query results. Ensure determinism and citeability.
- **Complexity**: 7
- **Dependencies**: Sprint 3
- **Validation**:
  - Add `tests/test_query_evaluation_fields.py`.

### Task 3.9: Determinism Inputs Recorded (Seeds, Locale/TZ, Model Versions)
- **Location**: `autocapture_nx/kernel/determinism.py`, `contracts/run_manifest.schema.json`
- **Description**: Close META-09 by recording determinism inputs explicitly in the run manifest.
- **Complexity**: 6
- **Dependencies**: Sprint 3
- **Validation**:
  - Add `tests/test_manifest_determinism_fields.py`.

### Task 3.10: Diagnostics Bundle Schema + Gate
- **Location**: `contracts/diagnostics_bundle.schema.json` (new), `autocapture_nx/cli.py`, `tools/gate_doctor.py`
- **Description**: Close META-10 by defining a canonical diagnostics bundle schema and ensuring exported bundles validate.
- **Complexity**: 6
- **Dependencies**: Sprint 3
- **Validation**:
  - Add `tests/test_diagnostics_bundle_schema.py`.

### Task 3.11: Operator Commands Completion + Migration Status Surfacing
- **Location**: `autocapture_nx/cli.py`, `autocapture_nx/kernel/doctor.py`
- **Description**: Close OPS-05/OPS-06/OPS-08 by finishing operator commands (`reindex`, `vacuum`, `quarantine`, `rollback-locks`), ledgering actions, and surfacing migration status (DB versions, timestamps, checksums). Ensure SLO/error budgets are first-class and fail gates on regression.
- **Complexity**: 9
- **Dependencies**: Sprint 2
- **Validation**:
  - Add `tests/test_operator_commands_ledgered.py`, `tests/test_doctor_reports_db_versions.py`, `tests/test_slo_budget_regression_gate.py`.

### Task 3.12: Self-Test Harness (CLI-first)
- **Location**: `autocapture/web/routes/doctor.py`, `autocapture_nx/kernel/query.py`
- **Description**: Close OPS-07 by implementing a deterministic self-test harness runnable without UI dependencies (CLI + route), which captures a short sample, extracts one segment, queries one prompt, and verifies ledger/integrity.
- **Complexity**: 8
- **Dependencies**: Sprint 1
- **Validation**:
  - Add `tests/test_self_test_harness.py`.

## Sprint 4: Performance (Incremental Indexing, Caching, WSL2 Round-Trip)
**Goal**: Reduce steady-state CPU/RAM while keeping determinism and citeability.
**Demo/Validation**:
- Confirm query uses metadata only (no decode/reprocess), and indexing is incremental.

### Task 4.1: Incremental Indexing By Evidence Hash
- **Location**: `autocapture/indexing/*`
- **Description**: Process only new/changed evidence IDs; maintain deterministic ordering.
- **Complexity**: 8
- **Dependencies**: Sprint 2
- **Validation**:
  - Add `tests/test_incremental_indexing.py`.

### Task 4.2: Derived-Step Cache (OCR/VLM/Embeddings) Keyed By Hashes
- **Location**: `autocapture_nx/processing/*`, `plugins/builtin/*`
- **Description**: Cache by `(evidence_hash, extractor_version, config_hash)`; never recompute on query.
- **Complexity**: 8
- **Dependencies**: Sprint 3
- **Validation**:
  - Add `tests/test_extractor_cache_keys.py`.

### Task 4.3: WSL2 Job Loop Round-Trip + Backpressure
- **Location**: `autocapture/runtime/wsl2_queue.py`, `autocapture/runtime/routing.py`
- **Description**: Implement full request/response protocol with bounded polling and deterministic backpressure.
- **Complexity**: 9
- **Dependencies**: Sprint 1
- **Validation**:
  - Add `tests/test_wsl2_job_roundtrip.py`.

## Sprint 5: Security + QA (Export Redaction, Egress Approval, Proof Signatures, Regression Suites)
**Goal**: Complete security posture and harden with deterministic regression suites.
**Demo/Validation**:
- Run security guard tests and verify export redaction is deterministic and only applied on explicit export.

### Task 5.1: Filesystem Guard Hardening (Windows Edge Cases)
- **Location**: `autocapture_nx/windows/win_paths.py`, `autocapture_nx/plugin_system/runtime.py`
- **Description**: Normalize/resolve symlinks, normalize case/UNC, deny traversal consistently.
- **Complexity**: 8
- **Dependencies**: Sprint 1
- **Validation**:
  - Add `tests/test_filesystem_guard_windows_edge_cases.py`.

### Task 5.2: Egress Default Approval + Allowlist + Ledger Events
- **Location**: `autocapture/egress/client.py`, `autocapture/web/routes/egress.py`, `config/default.json`
- **Description**: Default `approval_required=true`; require per-destination allowlists; ledger each egress.
- **Complexity**: 7
- **Dependencies**: Sprint 3
- **Validation**:
  - Add `tests/test_egress_requires_approval_by_default.py`.

### Task 5.3: Export/Boundary Redaction (Deterministic) + Redaction Map
- **Location**: `autocapture/privacy/redaction.py`, `autocapture/egress/sanitize.py`
- **Description**: Detect/redact PII only on export/egress; persist a redaction map in exported metadata.
- **Complexity**: 9
- **Dependencies**: Task 5.2
- **Validation**:
  - Add `tests/test_redaction_deterministic.py`.

### Task 5.4: Proof Bundle Signature + Verify On Import/Replay
- **Location**: `autocapture_nx/kernel/proof_bundle.py`
- **Description**: Sign bundle manifest locally; verify on import; include sha256 for all files.
- **Complexity**: 8
- **Dependencies**: Sprint 3
- **Validation**:
  - Add `tests/test_proof_bundle_signature_verifies.py`, `tests/test_proof_bundle_verify.py`.

### Task 5.5: QA Golden + Chaos + Fuzz + Sandbox Regression Suite
- **Location**: `tests/test_query_golden.py` (new), `tests/test_crash_recovery_chaos.py` (new), `tests/test_security_guards.py` (new)
- **Description**: Add deterministic fixtures + stubbed model plugins to ensure stable answers/citations; add crash recovery chaos tests; add config/manifest fuzz corpus; add sandbox regression suite.
- **Complexity**: 10
- **Dependencies**: Sprints 1-4
- **Validation**:
  - New tests pass deterministically on repeated runs.

### Task 5.6: Subprocess Network Guard Early-Import Coverage (sitecustomize)
- **Location**: `autocapture_nx/plugin_system/host_runner.py`, `autocapture_nx/plugin_system/runtime.py`
- **Description**: Close SEC-02 by ensuring network guard is applied before plugin imports in subprocess mode (including common HTTP libs); add deterministic tests.
- **Complexity**: 7
- **Dependencies**: Sprint 1
- **Validation**:
  - Add `tests/test_network_guard_applies_before_imports.py`.

### Task 5.7: Loopback Binding Enforcement (Config + Runtime)
- **Location**: `config/default.json`, `autocapture/web/api.py`, `ops/dev/launch_tray.ps1`
- **Description**: Close SEC-03: validate bind address is loopback-only; runtime refuses to start if configured otherwise; tests cover tray launcher respects bind.
- **Complexity**: 6
- **Dependencies**: Sprint 0
- **Validation**:
  - Add `tests/test_tray_launcher_respects_bind.py`.

### Task 5.8: Key Rotation Hardening (key_id Everywhere + Rewrap Plan)
- **Location**: `autocapture/crypto/keyring.py`, `plugins/builtin/storage_encrypted/plugin.py`, `autocapture/web/routes/keys.py`
- **Description**: Close SEC-06: store `key_id` with encrypted data; support staged rewrap + mixed-key reads; deterministic plan + verification.
- **Complexity**: 9
- **Dependencies**: Sprint 2
- **Validation**:
  - Add `tests/test_key_rotation_rewrap_plan.py`.

### Task 5.9: Capture Consent Events (Ledgered) + Tray Indicator Invariants
- **Location**: `autocapture/tray/app.py`, `plugins/builtin/ledger_basic/plugin.py`
- **Description**: Close SEC-08 by ensuring capture consent is explicit (indicator) and start/stop are ledgered. Ensure tray does not provide capture pause/deletion actions, only processing pause (per non-negotiables).
- **Complexity**: 7
- **Dependencies**: Sprint 3
- **Validation**:
  - Add `tests/test_capture_start_stop_ledgered.py`.

### Task 5.10: Secrets Hygiene + Secret Scan Gate
- **Location**: `autocapture_nx/plugin_system/host_runner.py`, `autocapture_nx/kernel/logging.py`, `tools/gate_secrets.py` (new)
- **Description**: Close SEC-09 by sanitizing subprocess env, redacting tokens in logs, and adding a repo gate for secret scanning with deterministic allowlist handling.
- **Complexity**: 8
- **Dependencies**: Sprint 3
- **Validation**:
  - Add `tests/test_log_redaction.py` and run `tools/gate_secrets.py` in CI.

### Task 5.11: Cloud/Gateway Two-Step Enablement
- **Location**: `autocapture/gateway/router.py`, `autocapture_nx/kernel/policy_gate.py`
- **Description**: Close SEC-10 by requiring both an explicit config enable and an egress approval to use any cloud/gateway path; block by default; deterministic tests.
- **Complexity**: 7
- **Dependencies**: Task 5.2
- **Validation**:
  - Add `tests/test_cloud_enable_requires_two_step.py`.

## Sprint 6: Minimal UI/Docs (To Satisfy Traceability, Not To Replace UI)
**Goal**: Implement doc/runbook + minimal UI compatibility surfaces required by redesign items.
**Demo/Validation**:
- `docs/runbook.md` covers operator flows.
- UI smoke tests (headless) run and pass.

### Task 6.1: Operator Runbook + Safe Mode Doc
- **Location**: `docs/runbook.md` (new), `docs/safe_mode.md` (new)
- **Description**: Provide deterministic procedures: backup/restore, plugin rollback, disk pressure, integrity verification, safe-mode triage.
- **Complexity**: 6
- **Dependencies**: Sprints 2-5
- **Validation**:
  - Add `tests/test_docs_consistency_smoke.py` or extend existing doc gates.

### Task 6.2: UI Smoke + a11y Baseline
- **Location**: `tests/test_ui_smoke.py` (new), `tests/test_accessibility_smoke.py` (new)
- **Description**: Minimal headless checks for critical pages; a11y checks for labels/focus order.
- **Complexity**: 7
- **Dependencies**: Sprint 3
- **Validation**:
  - Tests run in CI headless and pass deterministically.

### Task 6.3: Roadmap Phase Docs (RD-01..RD-04) As Implemented Planning Artifacts
- **Location**: `docs/roadmap.md` (new), `docs/plans/*`
- **Description**: Close RD-01..RD-04 by writing a deterministic roadmap that maps the phased redesign items to concrete deliverables and the gates that prove them; ensure traceability evidence points to these docs (not `(planning)` placeholders).
- **Complexity**: 4
- **Dependencies**: None
- **Validation**:
  - `tools/run_adversarial_redesign_coverage.sh` no longer reports RD-01..RD-04 as missing.

### Task 6.4: Safe Mode Visibility (CLI + Minimal UI Banner)
- **Location**: `autocapture_nx/kernel/loader.py`, `docs/safe_mode.md`, `autocapture/web/ui/index.html`
- **Description**: Close FND-10 by surfacing safe-mode and crash-loop reasons (CLI-first) and providing deterministic “next safe action” guidance. UI changes minimal and verifiable.
- **Complexity**: 7
- **Dependencies**: Sprint 2
- **Validation**:
  - Add `tests/test_safe_mode_ui_banner.py`.

## Coverage Map (IDs -> Sprint)
Target IDs are the set of `missing` + `partial` from `docs/reports/adversarial-redesign-gap-2026-02-08.md`.
- EXEC-01..03, EXEC-10: Sprint 1
- EXEC-04..07: Sprint 1 (replay / determinism / two-phase commit / schedule-from-query)
- EXT-01..12: Sprint 1 (Task 1.7)
- FND-05..06, FND-08, FND-10: Sprint 2 + Sprint 6.4
- META-04, META-07..10: Sprint 3 (Tasks 3.6-3.10)
- OPS-05..08: Sprint 3 (Tasks 3.11-3.12)
- PERF-01..06, PERF-08: Sprint 4
- QA-01..06, QA-08: Sprint 5
- SEC-02..03, SEC-05..10: Sprint 5
- UX-01..10: Sprint 6 (minimal UI + tests only; UI rewrite deferred)
- RD-01..04, RD-06: Sprint 6 (docs)

## Testing Strategy
- Prefer unit tests for deterministic contracts (ordering, hashing, schema versioning).
- Use fixture-driven integration tests for:
  - PNG screenshot pipeline.
  - ffmpeg MP4 pipeline (decode -> extract -> index -> query).
- Run performance gates only after correctness gates pass; keep them single-worker in WSL.

## Potential Risks & Gotchas
- WSL stability: plugin-host subprocess storms can crash WSL; cap concurrency early (Sprint 1).
- Traceability parser pitfalls: parentheses or non-path tokens in doc fields cause false “missing”.
- “UI later” tension: implement minimal endpoints/tests for UX-* without building a full UI.
- Security boundaries: keep raw-first local store; ensure redaction is export/egress-only.
- Migrations: write forward-only migrations but keep rollback plan/documentation deterministic.

## Rollback Plan
- Each sprint lands as small commits; revert by `git revert` of the specific commit(s).
- For state/schema changes, add migrations that can be disabled via config flags during rollback window.
